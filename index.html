<!DOCTYPE html>
<html dir="rtl">

<head>
    <title>Work Item Details</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<style>
            #loader {
            border: 12px solid #f3f3f3;
            border-radius: 50%;
            border-top: 12px solid #444444;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
        }
 
        .center {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
        }
 
        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    .table-striped tbody tr:nth-of-type(odd):hover {
        background-color: rgb(231, 25, 25);
        /* Change to your desired hover background color */
        cursor: pointer;
        !important
    }

    tr.even:hover {
        background-color: #983636;
        /* Change to your desired hover color */
        cursor: pointer;
        !important
    }
    .bd {
      background-color: #f8f9fa;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      max-width: 400px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
      min-width: 300px;
    }

    .login-container h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      font-weight: bold;
      text-align: center;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .form-group button {
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .error-message {
      color: red;
      margin-top: 10px;
      text-align: center;
    }
    .modal-body {
        text-align: right;
}
.dataTables_wrapper {
    padding: 20px;
}
.table thead th {
    vertical-align: center;
    text-align: center;
}
</style>

<body>
    <div id="loader" class="center"></div>
    <!-- Login Page -->
    <div id="login-page">
        <div class="bd">
        <div class="login-container">
            <h2>כניסה למערכת</h2>
            <form id="loginForm">
                <div class="form-group">
                    <center><label for="username">שם משתמש</label></center>
                    <input type="text" id="username" name="username" placeholder="Enter your username" dir="ltr">
                </div>
                <div class="form-group">
                <center><label for="password">סיסמא</label></center>
                    <input type="password" id="password" name="password" placeholder="Enter your password" dir="ltr">
                </div>
                <div class="form-group">
                    <button type="submit">כניסה</button>
                </div>
                <div id="errorMessage" class="error-message"></div>
            </form>
            <div class="image-container">
                <div class="image-wrapper">
                  <center><a href="#"><img src="https://evrotarget.com/wp-content/uploads/2022/02/MicrosoftTeams-image-92-1-1500x630.png" alt="HTML tutorial" style="width:70%;"></a></center>
                </div>
                <div class="image-wrapper">
                  <center><a href="#"><img src="https://upload.wikimedia.org/wikipedia/he/thumb/b/b0/Abra_logo.svg/1280px-Abra_logo.svg.png" alt="HTML tutorial" style="width:20%;"></a></center>
                </div>
              </div>
        </div>

    </div>

    </div>

    <!-- Second Page -->
    <div id="second-page" style="display: none;">
        <table id="response-table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>מספר מזהה</th>
                    <th>סוג</th>
                    <th>מצב</th>
                    <th>מוקצה אל</th>
                    <th>כותרת</th>
                    <th>תיאור</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be dynamically populated here -->
            </tbody>
        </table>

        <!-- Modal for displaying work item details -->
        <div class="modal fade" id="workItemModal" tabindex="-1" role="dialog" aria-labelledby="workItemModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="workItemModalLabel">מידע על פריט העבודה</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="workItemDetails">
                        <!-- Work item details will be dynamically populated here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Check if the user is valid


            // Login form submission

            const apiUrl = 'https://prod-74.westus.logic.azure.com:443/workflows/c35875e861b241e9a2c081f4d9ded780/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=tahqZUBU2jTDXBbKz8WjMkueBWPzdDaPbaYSi22MaQQ';

            const loginForm = document.getElementById('loginForm');
            const errorMessage = document.getElementById('errorMessage');

            const validateUser = async (event) => {
                event.preventDefault();

                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                const requestData = {
                    username: username,
                    password: password
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    const data = await response.json();

                    // Process the response data
                    if (response.ok) {
                        if (data.valid === 'yes') {
                            console.log('User is valid');
                            console.log(data);
                            // Redirect to a new page or perform other actions for successful login
                            errorMessage.textContent = 'User is valid'; // Display a success message
                            errorMessage.style.color = 'green';
                            $('#login-page').hide();
                            $('#second-page').show();
                            fetchData();
                        } else {
                            console.log('User is not valid');
                            console.log(data.valid);
                            // Display an error message or perform other actions for unsuccessful login
                            errorMessage.textContent = 'Invalid username or password'; // Display an error message
                            errorMessage.style.color = 'red';
                            document.getElementById('username').value = '';
                            document.getElementById('password').value = '';
                        }
                    } else {
                        console.log('Request failed with status:', response.status);
                        errorMessage.textContent = 'An error occurred. Please try again later.'; // Display an error message
                        errorMessage.style.color = 'red';
                        document.getElementById('username').value = '';
                        document.getElementById('password').value = '';
                    }
                } catch (error) {
                    console.error('An error occurred:', error);
                    errorMessage.textContent = 'An error occurred. Please try again later.'; // Display an error message
                    errorMessage.style.color = 'red';
                }
            };
            loginForm.addEventListener('submit', validateUser);

            // Function to fetch data from the API and populate the table
            function fetchData() {
                document.querySelector("#loader").style.display = "block";
                document.querySelector("body").style.visibility = "hidden";
                fetch('https://prod-179.westus.logic.azure.com:443/workflows/fde64084ea874d0f9efdead54552df50/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=xIk9Z-QEs1AVGFJKpQG1Yc0gD8eu07xjOm-iixnwds4')
                    .then(response => response.json())
                    .then(data => {
                        // Update the table with the received data
                        document.querySelector("#loader").style.display = "none";
                        document.querySelector("body").style.visibility = "visible";
                        updateTable(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

                function updateTable(data) {
                    // Get the table body element
                    var tableBody = $('#response-table tbody');

                    // Clear existing table rows
                    tableBody.empty();

                    // Iterate over the data and create table rows
                    data.forEach(item => {
                        var row = $('<tr>');
                        row.append('<td>' + item['System.Id'] + '</td>');
                        row.append('<td>' + item['System.WorkItemType'] + '</td>');

                        // Check if System.State is 'New' and set the background color accordingly
                        if (item['System.State'] === 'New') {
                            row.append('<td style="background-color: green;">' + item['System.State'] + '</td>');
                        } else if (item['System.State'] === 'Closed') {
                            row.append('<td style="background-color: yellow;">' + item['System.State'] + '</td>');
                        } else {
                            row.append('<td>' + item['System.State'] + '</td>');
                        }
                        if (item['System.AssignedTo']) {
                            row.append('<td>' + item['System.AssignedTo'] + '</td>');
                        } else {
                            row.append('<td></td>');
                        }

                        row.append('<td>' + item['System.Title'] + '</td>');
                        if (item['System.Description']) {
                            row.append('<td>' + item['System.Description'] + '</td>');
                        } else {
                            row.append('<td></td>');
                        }

                        row.click(function () {
                            // Display work item details in the modal
                            showModal(item);
                        });

                        tableBody.append(row);
                    });

                    // Initialize DataTable
                    $('#response-table').DataTable({
                        dom: 'Bfrtip',
                        buttons: [
                            'copy', 'csv', 'excel', 'pdf', 'print'
                        ]
                    });
                }

                function showModal(item) {
                    // Populate modal with work item details
                    var modalBody = $('#workItemDetails');
                    modalBody.empty();
                    modalBody.append('<p><strong>מספר מזהה:</strong> ' + item['System.Id'] + '</p>');
                    modalBody.append('<p><strong>סוג:</strong> ' + item['System.WorkItemType'] + '</p>');
                    modalBody.append('<p><strong>מצב:</strong> ' + item['System.State'] + '</p>');
                    modalBody.append('<p><strong>כותרת:</strong> ' + item['System.Title'] + '</p>');

                    // Check if Description field exists and is not null
                    if (item['System.Description']) {
                        modalBody.append('<p><strong>תיאור:</strong> ' + item['System.Description'] + '</p>');
                    }

                    // Show the modal
                    $('#workItemModal').modal('show');
                }
            }
        });
        document.onreadystatechange = function () {
            if (document.readyState !== "complete") {
                document.querySelector(
                    "body").style.visibility = "hidden";
                document.querySelector(
                    "#loader").style.visibility = "visible";
            } else {
                document.querySelector(
                    "#loader").style.display = "none";
                document.querySelector(
                    "body").style.visibility = "visible";
            }
        };

    </script>
</body>

</html>
